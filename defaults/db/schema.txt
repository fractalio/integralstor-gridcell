CREATE TABLE "email_config" (
"id" integer NOT NULL PRIMARY KEY,
"server" varchar(40) NOT NULL,
"port" integer NOT NULL,
"username" varchar(40) NOT NULL,
"pswd" varchar(40) NOT NULL,
"tls" bool NOT NULL,
"email_alerts" bool NOT NULL,
"email_audit" bool NOT NULL,
"email_quota" bool NOT NULL,
"rcpt_list" varchar(400) NOT NULL
);

CREATE TABLE "scheduler_tasks" (
    "task_id" integer NOT NULL PRIMARY KEY,
    "task_name" varchar(200) NOT NULL,
    "create_time" datetime NOT NULL,
    "initiate_time" datetime NOT NULL,
    "status" varchar(50) NOT NULL,
    "node" varchar(200),
    "deleteble" integer,
    "execute_after" integer NOT NULL
, user_name VARCHAR(100) NOT NULL DEFAULT 'root'
 );

CREATE TABLE "scheduler_commands" (
    "command_id" integer NOT NULL PRIMARY KEY,
    "name" varchar(100) NOT NULL,
    "command"  varchar(400) NOT NULL,
    "task_ref_id" integer NOT NULL,
    "status" varchar(100),
    "return_code" varchar(10),
    "output" text,
    "errors" text,
    "retries" integer NOT NULL,
    FOREIGN KEY(task_ref_id) REFERENCES scheduler_tasks(task_id)
);
drop table scheduler_tasks;
drop table scheduler_commands;

CREATE TABLE "cron_tasks" (
  "cron_task_id" integer NOT NULL PRIMARY KEY,
  "description" varchar(200) NOT NULL,
  "command" varchar(200) NOT NULL
);
CREATE TABLE "subtasks" (
  "subtask_id" integer NOT NULL PRIMARY KEY,
  "description" varchar(100) NOT NULL,
  "command"  varchar(400) NOT NULL,
  "task_id" integer NOT NULL,
  "status" varchar(100) NOT NULL DEFAULT 'queued',
  "return_code" varchar(10),
  FOREIGN KEY(task_id) REFERENCES tasks(task_id)
);
CREATE TABLE "tasks" (
  "task_id" integer NOT NULL PRIMARY KEY,
  "description" varchar(200) NOT NULL,
  "task_type_id" integer NOT NULL,
  "node" varchar(200) NOT NULL,
  "run_as_user_name" VARCHAR(100) NOT NULL DEFAULT 'root',
  "attempts" integer NOT NULL,
  "cron_task_id" integer NOT NULL,
  "retry_interval" integer NOT NULL DEFAULT 1,
  "create_time" datetime NOT NULL,
  "initiate_time" datetime NOT NULL,
  "last_run_time" datetime,
  "status" varchar(50) NOT NULL DEFAULT 'queued',
  FOREIGN KEY(task_type_id) REFERENCES task_types(task_type_id)
);
CREATE TABLE "task_types" (
  "task_type_id" integer NOT NULL PRIMARY KEY,
  "description" varchar(200) NOT NULL
);
CREATE TABLE "remote_replications" (
  "remote_replication_id" integer NOT NULL PRIMARY KEY,
  "source_dataset" varchar(100) NOT NULL,
  "destination_ip" varchar(100) NOT NULL,
  "destination_user_name" varchar(100) NOT NULL,
  "destination_pool" varchar(100) NOT NULL,
  "cron_task_id" NOT NULL,
  FOREIGN KEY(cron_task_id) REFERENCES cron_tasks(cron_task_id)
);
insert into task_types (task_type_id, description) values (0, 'Unspecified');
insert into task_types (task_type_id, description) values (1, 'Disk replacement');
insert into task_types (task_type_id, description) values (2, 'Service restart');
insert into task_types (task_type_id, description) values (3, 'ZFS scrub');
insert into task_types (task_type_id, description) values (4, 'Remote replication');



import shutil
import integralstor_common
from integralstor_common import common

def add_to_nodes_file(ip_list):
  existing_ips = []
  try :
    try:
      with open('/etc/ctdb/nodes', 'r') as f:
        for line in f:
          existing_ips.append(line.strip())
    except Exception, e:
      #In case there is no file existing, go ahead
      pass
    if not ip_list:
      raise Exception("No IPs to add to the CTDB nodes file!")
    with open('/etc/ctdb/nodes', 'a') as f:
      for ip in ip_list:
        if existing_ips:
          if ip.strip() not in existing_ips:
            f.write("%s\n"%ip)
        else:
          f.write("%s\n"%ip)
  except Exception, e:
    return False, "Error adding IPs to the CTDB Nodes file : %s"%str(e)
  else:
    return True, None

def remove_from_nodes_file(ip_list):
  try:
    config_dir, err = common.get_config_dir()
    if err:
      raise Exception(err)
    with open('/tmp/ctdb_nodes_file', 'w') as f1:
      with open('%s/lock/nodes'%config_dir, 'r') as f:
        for line in f:
          if line.strip() in ip_list:
            continue
          else:
            f1.write('%s\n'%line.strip())
    shutil.move('/tmp/ctdb_nodes_file', '%s/lock/nodes'%config_dir)
  except Exception, e:
    return False, "Error removing IPs from the CTDB Nodes file : %s"%str(e)
  else:
    return True, None

def create_config_file():

  try :
    config_dir, err = common.get_config_dir()
    if err:
      raise Exception(err)
    with open("/etc/sysconfig/ctdb", "w") as f:
      f.write("CTDB_RECOVERY_LOCK=%s/lock/lockfile\n"%config_dir)
      f.write("CTDB_MANAGES_SAMBA=yes\n")
      f.write("CTDB_MANAGES_WINBIND=yes\n")
      f.write("CTDB_SAMBA_SKIP_SHARE_CHECK=yes\n")
      f.write("CTDB_NODES=/etc/ctdb/nodes\n")
      f.close()
  except Exception, e:
    return False, "Error creating ctdb config file : %s"%str(e)
  else:
    return True, None

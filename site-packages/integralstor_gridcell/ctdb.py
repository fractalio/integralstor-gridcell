import shutil
import integralstor_common
from integralstor_common import common, command
import salt.client

def add_to_nodes_file(client, ip_list, reload_nodes_file = True):
  existing_ips = []
  try :
    if not client:
      client = salt.client.LocalClient()
    try:
      with open('/etc/ctdb/nodes', 'r') as f:
        for line in f:
          existing_ips.append(line.strip())
    except Exception, e:
      #In case there is no file existing, go ahead
      pass
    if not ip_list:
      raise Exception("No IPs to add to the CTDB nodes file!")
    with open('/etc/ctdb/nodes', 'a') as f:
      for ip in ip_list:
        if existing_ips:
          if ip.strip() not in existing_ips:
            f.write("%s\n"%ip)
        else:
          f.write("%s\n"%ip)
    if reload_nodes_file:
      r1 = client.cmd('*', 'cmd.run_all', ['ctdb reloadnodes'])
      if r1:
        for node, ret in r1.items():
          #print ret
          if ret["retcode"] != 0:
            raise Exception("Error reloading CTDB nodes file on %s"%node)
  except Exception, e:
    return False, "Error adding IPs to the CTDB Nodes file : %s"%str(e)
  else:
    return True, None

def remove_from_nodes_file(client, ip_list, reload_nodes_file=True):
  try:
    if not client:
      client = salt.client.LocalClient()
    config_dir, err = common.get_config_dir()
    if err:
      raise Exception(err)
    with open('/tmp/ctdb_nodes_file', 'w') as f1:
      with open('%s/lock/nodes'%config_dir, 'r') as f:
        for line in f:
          if line.strip() in ip_list:
            continue
          else:
            f1.write('%s\n'%line.strip())
    shutil.move('/tmp/ctdb_nodes_file', '%s/lock/nodes'%config_dir)
    if reload_nodes_file:
      r1 = client.cmd('*', 'cmd.run_all', ['ctdb reloadnodes'])
      if r1:
        for node, ret in r1.items():
          print ret
          if ret["retcode"] != 0:
            raise Exception("Error reloading CTDB nodes file on %s"%node)
  except Exception, e:
    return False, "Error removing IPs from the CTDB Nodes file : %s"%str(e)
  else:
    return True, None

def create_config_file():

  try :
    config_dir, err = common.get_config_dir()
    if err:
      raise Exception(err)
    with open("/etc/sysconfig/ctdb", "w") as f:
      f.write("CTDB_RECOVERY_LOCK=%s/lock/lockfile\n"%config_dir)
      f.write("CTDB_MANAGES_SAMBA=yes\n")
      f.write("CTDB_MANAGES_WINBIND=yes\n")
      f.write("CTDB_SAMBA_SKIP_SHARE_CHECK=yes\n")
      f.write("CTDB_NODES=/etc/ctdb/nodes\n")
      f.close()
  except Exception, e:
    return False, "Error creating ctdb config file : %s"%str(e)
  else:
    return True, None

def get_status():
  status_dict = {}
  try:
    lines, err = command.get_command_output('ctdb -Y status')
    if err:
      raise Exception(err)
    i = 0
    for line in lines:
      if i == 0:
        i += 1
        continue
      print line
      components = line.split(':')
      #print components
      ok = True
      status = ''
      if components:
        if components[3] != '0':
          status += '| Banned |'
          ok = False
        if components[4] != '0':
          status += '| Disabled |'
          ok = False
        if components[5] != '0':
          status += '| Unhealthy |'
          ok = False
        if components[6] != '0':
          status += '| Stopped |'
          ok = False
        if components[7] != '0':
          status += '| Inactive |'
          ok = False
        if components[8] != '0':
          status += '| PartiallyOnline |'
          ok = False
        if ok:
          status += 'OK'
        status_dict[components[2]] = status
      i += 1
  except Exception, e:
    return None, "Error retrieving CTDB status: %s"%str(e)
  else:
    return status_dict, None

def main():
  print get_status()

if __name__ == '__main__':
  main()
